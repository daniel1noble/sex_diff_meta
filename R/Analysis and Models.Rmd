---
title: "Data Analysis and Meta-A Models"
author: "Lauren Harrison"
date: "28/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Load packages
```{r}
# Clear work space
  rm(list=ls())

# Install CRAN packages
  install.packages("pacman")

# Install orchard plot package
  devtools::install_github("itchyshin/orchard_plot", subdir = "orchaRd", force = TRUE, build_vignettes = TRUE); 
  devtools::install_github("daniel1noble/metaAidR"); 

  pacman::p_load(knitr, metafor, dplyr, kableExtra, tidyverse, rotl, phytools, GGally, R.rsp, patchwork, devtools, robumeta, ape, geiger, phytools, phangorn, rlist, orchaRd, metaAidR)

# Source our own functions
  source("./R/func.R")
```

# 2. Load datasets
```{r}
pers <- read.csv("./data/pers_data.csv")
head(pers)
nrow(pers) # just to see how much data we started off with
bodysize <- read.csv("./data/bodysize_SSD.csv")
head(bodysize)
```

# 3. Fix "pers" dataset before we get started
```{r}
# remove whitespace
  spp_names <- trimws(c(as.character(pers$species_name),
                        as.character(bodysize$species_name), 
                        which = "both"))

# merge spp_names columns
  pers <- merge(pers,bodysize[,c("species_name", "m_BS", "m_SE", "f_BS", "f_SE", "measure", "SSD_index", "mating_system", "parental_care")],by="species_name", all.x = TRUE,  no.dups = TRUE)
  summary(pers)
  nrow(pers) #

#colnames(pers) <- gsub(".[xy]", "", colnames(pers))

# Just select the relevant columns for now to make life easier
  pers_new <- pers %>% select(study_ID, year, species_name, mating_system, parental_care, SSD_index, taxo_group, measure, data_type, personality_trait, male_n, male_mean, m_SE_to_SD, female_n, female_mean, f_SE_to_SD, depend, directionality, spp_name_phylo)

# Check out some outliers
  pers_new %>%
  filter(is.na(SSD_index))

# Check species numbers
  pers_new %>%
  group_by(taxo_group) %>%
  summarise(species = length(unique(species_name)))

# Rename spp
  pers_new <- pers_new %>% 
              mutate(spp = gsub(" ", "_", species_name))

  data.frame(pers_new %>% 
  filter(!is.na(parental_care)) %>%
  group_by(taxo_group, personality_trait, parental_care) %>%
  summarise(studies = length(unique(study_ID)), effects = n()))

# Add in observation level random effect
  pers_new <- pers_new %>% 
            group_by(taxo_group) %>% 
            mutate(obs = 1:length( study_ID))
```

# 4. Calculate effect sizes (SMD and lnCVR)
```{r}
# calculating effect sizes

# SMD (Hedge's g)
  pers_new <- escalc(measure = "SMD", 
                n1i = male_n, n2i = female_n,
                m1i = male_mean, m2i = female_mean,
                sd1i = m_SE_to_SD, sd2i = f_SE_to_SD, data = pers_new, var.names=c("SMD_yi","SMD_vi"), append = TRUE)

# lnCVR
  pers_new <- escalc(measure = "CVR",
                       n2i = female_n, n1i = male_n,
                       m2i = female_mean, m1i = male_mean,
                       sd2i = f_SE_to_SD, sd1i = m_SE_to_SD, data = pers_new, var.names=c("CVR_yi","CVR_vi"))

# Find out why we have na? Seems like this is because SD in one of the sexes is zero. We could add a very small number here or assume 0 is NA and impute, but I would just exclude.
  dim(pers_new %>%
  filter(is.na(CVR_yi)))

# Exclude NAs
  pers_new <- pers_new %>%
              filter(!is.na(CVR_yi), !is.na(SMD_yi))
  dim(pers_new)            
```

# Plot effect sizes to see how they look
```{r}
# lnCVR
  hist(pers_new$CVR_yi)
  funnel(x = pers_new$CVR_yi, vi = pers_new$CVR_vi, yaxis="seinv", xlim = c(-10, 10))

#SMD
  hist(pers_new$SMD_yi)
  funnel(x = pers_new$SMD_yi, vi = pers_new$SMD_vi, yaxis="seinv")

# Effect sizes 3 and above
  pers_new %>%
  filter(SMD_yi > 3)
  
# checking SMD outliers
  # P038 is correct as reported in paper, but is a proportion
  # P029 has male SD wrong - paper says 64.4 but was recorded as 0.001 for some reason - amended in pers dataset
  # P017 is correct
  # P021 looks weird in paper too but is correct
  # P136 is correct
  # P014 is correct
```

### NEED TO DO BEFORE RUNNING PROPER MODELS ### 
1. Need to transform proportions to logits, then to Hedge's g? 
2. Scores - cut them out?
# Sensitivity analysis to see if proportion or score data make a difference to conclusions if you cut them out.
3. Flip signs where indicated 
# Yes!

# Lets flip signs of effects for SMD
The directional meaning of effect sizes vary depending on the specific units and trait being measured. The data has a directionality column that tells one if the meaning should be reversed (1) or left the same. 

```{r}
   pers_new$directionality <- ifelse(is.na(pers_new$directionality), 0, 1)

      pers_new$SMD_yi_flip <- ifelse(pers_new$directionality == 1, pers_new$SMD_yi*(-1), pers_new$SMD_yi)
```
# Prepare the phylogenic trees
For each taxonomic group the phylogenetic trees have been constructed. We'll use these trees for multi-level meta-analytic models throughout. 

```{r}
    tree_files <- paste0("./trees/", list.files("./trees"))[-1]

    read_birds <- function(x){
          tr <- read.nexus(x)
          ave.tree <- midpoint(ls.consensus(tr))
          return(ave.tree)
    }

    # Read in bird trees (100) and take the average tree as concensus tree
       tree_bird <- read_birds(tree_files[1])
        
    # Get the rest of the taxa    
      trees <- lapply(tree_files[c(2:length(tree_files))], function(x) read.tree(x))
      names <- gsub("./trees/", "", tree_files)
      names(trees) <- names[c(2:length(tree_files))]

    # Plot the trees and see how they look
      par(mfrow = c(1,5), mar = c(1,1,1,1))
      plot(tree_bird)
      lapply(trees, function(x) plot(x, cex = 1))

    # Check that they are ultrametric
      is.ultrametric(tree_bird)
      lapply(trees, function(x) is.ultrametric(x))

    # Check that all names in the phylogeny are also in the data
      taxa_data_list <- split(pers_new, pers_new$taxo_group)
    
      tree_checks(taxa_data_list[[1]], tree_bird)
      
      other_groups <- mapply(x = taxa_data_list[-1], 
                             y = trees, 
                             function(x,y) tree_checks(x,y))

      #Print out each taxon group
      for(i in colnames(other_groups)){
            print(i)
            print(other_groups[,i] )
      }

      #pruned.tree<-drop.tip(tree,tree$tip.label[-match(species, tree$tip.label)]) ; Can use this to prune trees...

    # Extract the phylogenetic correlation matrices
      phylo_vcv_birds <- vcv(tree_bird, corr= TRUE)
            phylo_vcv <- lapply(trees, function(x) vcv(x, corr = TRUE))

    # Combine these together in a list
                     phylo_VCVs <- phylo_vcv
         phylo_VCVs[[names[1]]] <- phylo_vcv_birds

    # Order list so birds are first
         phylo_VCVs <- phylo_VCVs %>%
            list.subset(names) #rlist package

```

# 5. models
Let's run the first bunch of models on the whole dataset. We'll start off with intercept only multi-level meta-analytic models, then move to multi-level meta-regression models. The functions in `func.R` should be consulted to see precisely what models are being fit across the taxonomic groups

```{r}
# Now we can fit some models. First our MLMA intercept only models, across each taxa
source("./R/func.R")
  MLMA_models <- meta_model_fits(pers_new, phylo_vcv, type = "int")

# View model results. Warning messages exist because there are NA values for lnCVR. These can be removed from the data. We can also get from these models estimates of heterogeneity from our models. Here we need the sampling variance vector and also the models for SMD and CVR. We can then use multivariate apply (mapply) across these lists

  split_taxa <- split(pers_new, pers_new$taxo_group)
    smd_mods <- lapply(MLMA_models, function(x) x$SMD)
  lnCVR_mods <- lapply(MLMA_models, function(x) x$lnCVR)

  I2_SMD <- mapply(function(x,y) I2(x, v = y$SMD_vi), x = smd_mods, y = split_taxa) # Should work, but you must remove NAs from data first
  do.call("cbind", I2_SMD[,"bird"])
  I2_CVR <- mapply(function(x,y) I2(x, v = y$lnCVR_vi), x = lnCVR_mods, y = split_taxa) # Should work, but you must remove NAs from data first
  do.call("cbind", I2_CVR[,"bird"])

# Now that we have our list of models, we can extract the estimates, CIs and even prediction intervals. Use our new orchaRd package to do this. 

  MLMA_estimates <- lapply(MLMA_models, function(x) lapply(x, function(c) mod_results(c, mod = "Int")))

  mod_result_table <- plyr::ldply(do.call("rbind", lapply(MLMA_estimates, function(x) lapply(x, function(c) print(c)))))

# We can also extract I2 estimates, or estimates of heterogeneity from these models using the I2 function in metaAidR


```

# 6. Partition dataset into the "big 5" personality traits for each taxonomic group (25 different dataframes)


# 7. Run random effects models for each of the personality traits separately, and for each of the taxonomic groups?

# 8. Phylogenetic trees
Tree for all the species together seems to be missing some species that aren't missing when the tree is made specifically for each taxonomic group... Use these taxa-specific trees instead?

